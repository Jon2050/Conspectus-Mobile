name: Deploy Channels

on:
  workflow_run:
    workflows:
      - Quality
    types:
      - completed

env:
  VITE_AZURE_CLIENT_ID: ${{ vars.VITE_AZURE_CLIENT_ID }}
  WEBSITE_REPO_FULL_NAME: ${{ vars.WEBSITE_REPO_FULL_NAME || 'Jon2050/conspectus' }}

permissions:
  contents: write
  actions: read
  pages: read

concurrency:
  group: deploy-channels-${{ github.event.workflow_run.head_branch || github.run_id }}
  cancel-in-progress: true

jobs:
  prepare-context:
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch != ''
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.context.outputs.branch_name }}
      branch_slug: ${{ steps.context.outputs.branch_slug }}
      head_sha: ${{ steps.context.outputs.head_sha }}
      is_main: ${{ steps.context.outputs.is_main }}
      preview_base_prefix: ${{ steps.context.outputs.preview_base_prefix }}
      preview_base_path: ${{ steps.context.outputs.preview_base_path }}
    steps:
      - name: Resolve deployment context
        id: context
        env:
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail

          branch_slug="$(python - <<'PY'
          import os

          branch_name = os.environ["BRANCH_NAME"].strip().lower()
          encoded = []

          for char in branch_name:
              if ("a" <= char <= "z") or ("0" <= char <= "9") or char == "-":
                  encoded.append(char)
              else:
                  encoded.append(f"_{ord(char):x}_")

          print("".join(encoded).strip("-"))
          PY
          )"

          if [ -z "${branch_slug}" ]; then
            echo "Failed to derive preview slug from branch '${BRANCH_NAME}'." >&2
            exit 1
          fi

          preview_base_prefix="/${REPO_NAME}"

          is_main='false'
          if [ "${BRANCH_NAME}" = 'main' ]; then
            is_main='true'
          fi

          {
            echo "branch_name=${BRANCH_NAME}"
            echo "branch_slug=${branch_slug}"
            echo "head_sha=${HEAD_SHA}"
            echo "is_main=${is_main}"
            echo "preview_base_prefix=${preview_base_prefix}"
            echo "preview_base_path=${preview_base_prefix}/previews/${branch_slug}/"
          } >> "${GITHUB_OUTPUT}"

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs:
      - prepare-context
    steps:
      - name: Checkout source commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-context.outputs.head_sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Validate required runtime env
        run: |
          if [ -z "${VITE_AZURE_CLIENT_ID}" ]; then
            echo "Missing repository variable VITE_AZURE_CLIENT_ID." >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build preview channel
        env:
          DEPLOY_CHANNEL: preview
          DEPLOY_PREVIEW_SLUG: ${{ needs.prepare-context.outputs.branch_slug }}
          DEPLOY_PREVIEW_BASE_PREFIX: ${{ needs.prepare-context.outputs.preview_base_prefix }}
        run: npm run build

      - name: Verify preview build channel paths and scope
        run: >-
          node scripts/verify-build-channel.mjs
          --dist dist
          --channel preview
          --base "${{ needs.prepare-context.outputs.preview_base_path }}"

      - name: Publish preview to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./dist
          destination_dir: previews/${{ needs.prepare-context.outputs.branch_slug }}
          keep_files: true
          full_commit_message: >-
            deploy(preview): ${{ needs.prepare-context.outputs.branch_name }}
            (${{ needs.prepare-context.outputs.head_sha }})

      - name: Verify preview deployment availability
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIEW_URL: >-
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ needs.prepare-context.outputs.branch_slug }}/
        run: |
          set -euo pipefail

          pages_api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/pages"
          pages_status="$(curl -sS -o pages-response.json -w '%{http_code}' \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H 'Accept: application/vnd.github+json' \
            "${pages_api_url}")"

          if [ "${pages_status}" != '200' ]; then
            echo "GitHub Pages site is not configured/available for this repository." >&2
            echo "Pages API status: ${pages_status}" >&2
            cat pages-response.json >&2 || true
            exit 1
          fi

          preview_index_url="${PREVIEW_URL}index.html"
          max_attempts=30
          for attempt in $(seq 1 "${max_attempts}"); do
            preview_status="$(curl -sS -L -o preview-index.html -w '%{http_code}' "${preview_index_url}")"
            if [ "${preview_status}" = '200' ] && grep -q 'id="app"' preview-index.html; then
              echo "Preview deployment is reachable at ${PREVIEW_URL}"
              exit 0
            fi

            if [ "${attempt}" -lt "${max_attempts}" ]; then
              echo "Preview check attempt ${attempt}/${max_attempts} not ready (status ${preview_status}); retrying in 10s..."
              sleep 10
            fi
          done

          echo "Preview deployment did not become reachable in time: ${PREVIEW_URL}" >&2
          echo "Last response status: ${preview_status}" >&2
          cat preview-index.html >&2 || true
          exit 1

      - name: Preview URL (reachable)
        run: |
          echo "Preview URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ needs.prepare-context.outputs.branch_slug }}/"

  publish-production-artifact:
    name: Publish Production Artifact
    runs-on: ubuntu-latest
    needs:
      - prepare-context
    if: needs.prepare-context.outputs.is_main == 'true'
    outputs:
      artifact_name: ${{ steps.handoff.outputs.artifact_name }}
      commit_sha: ${{ steps.handoff.outputs.commit_sha }}
      quality_run_id: ${{ steps.handoff.outputs.quality_run_id }}
      deploy_run_id: ${{ steps.handoff.outputs.deploy_run_id }}
    steps:
      - name: Checkout source commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-context.outputs.head_sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Validate required runtime env
        run: |
          if [ -z "${VITE_AZURE_CLIENT_ID}" ]; then
            echo "Missing repository variable VITE_AZURE_CLIENT_ID." >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build production channel
        env:
          DEPLOY_CHANNEL: production
        run: npm run build

      - name: Verify production build channel paths and scope
        run: >-
          node scripts/verify-build-channel.mjs
          --dist dist
          --channel production
          --base /conspectus/webapp/

      - name: Resolve production handoff identity
        id: handoff
        run: |
          build_time_utc="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          artifact_name="conspectus-mobile-production-${{ needs.prepare-context.outputs.head_sha }}"
          {
            echo "artifact_name=${artifact_name}"
            echo "commit_sha=${{ needs.prepare-context.outputs.head_sha }}"
            echo "quality_run_id=${{ github.event.workflow_run.id }}"
            echo "deploy_run_id=${{ github.run_id }}"
            echo "build_time_utc=${build_time_utc}"
          } >> "${GITHUB_OUTPUT}"

      - name: Add production artifact metadata
        run: |
          cat > dist/deploy-metadata.json <<EOF
          {
            "channel": "production",
            "basePath": "/conspectus/webapp/",
            "sourceBranch": "${{ needs.prepare-context.outputs.branch_name }}",
            "commitSha": "${{ steps.handoff.outputs.commit_sha }}",
            "buildTimeUtc": "${{ steps.handoff.outputs.build_time_utc }}",
            "qualityRunId": "${{ steps.handoff.outputs.quality_run_id }}",
            "deployRunId": "${{ steps.handoff.outputs.deploy_run_id }}"
          }
          EOF

      - name: Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.handoff.outputs.artifact_name }}
          if-no-files-found: error
          path: dist

      - name: Verify production handoff outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          artifacts_api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts"
          artifacts_status="$(curl -sS -o artifacts-response.json -w '%{http_code}' \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H 'Accept: application/vnd.github+json' \
            "${artifacts_api_url}")"

          if [ "${artifacts_status}" != '200' ]; then
            echo "Failed to list run artifacts for production handoff verification." >&2
            echo "Artifacts API status: ${artifacts_status}" >&2
            cat artifacts-response.json >&2 || true
            exit 1
          fi

          node scripts/verify-production-handoff.mjs \
            --artifacts-json artifacts-response.json \
            --metadata dist/deploy-metadata.json \
            --artifact-name "${{ steps.handoff.outputs.artifact_name }}" \
            --commit-sha "${{ steps.handoff.outputs.commit_sha }}" \
            --quality-run-id "${{ steps.handoff.outputs.quality_run_id }}" \
            --deploy-run-id "${{ steps.handoff.outputs.deploy_run_id }}"

  dispatch-production-ready:
    name: Dispatch Production Ready
    runs-on: ubuntu-latest
    needs:
      - publish-production-artifact
    if: needs.publish-production-artifact.result == 'success'
    steps:
      - name: Validate producer dispatch token
        run: |
          if [ -z "${{ secrets.WEBSITE_REPO_DISPATCH_TOKEN }}" ]; then
            echo "Missing required secret WEBSITE_REPO_DISPATCH_TOKEN." >&2
            echo "This token must be scoped to trigger workflow events in ${WEBSITE_REPO_FULL_NAME}." >&2
            exit 1
          fi

      - name: Trigger deterministic website handoff event
        env:
          DISPATCH_TOKEN: ${{ secrets.WEBSITE_REPO_DISPATCH_TOKEN }}
        run: |
          set -euo pipefail

          cat > dispatch-payload.json <<EOF
          {
            "event_type": "conspectus-mobile-production-ready",
            "client_payload": {
              "commitSha": "${{ needs.publish-production-artifact.outputs.commit_sha }}",
              "deployRunId": "${{ needs.publish-production-artifact.outputs.deploy_run_id }}",
              "qualityRunId": "${{ needs.publish-production-artifact.outputs.quality_run_id }}",
              "artifactName": "${{ needs.publish-production-artifact.outputs.artifact_name }}"
            }
          }
          EOF

          dispatch_status="$(curl -sS -o dispatch-response.txt -w '%{http_code}' \
            -X POST \
            -H "Authorization: Bearer ${DISPATCH_TOKEN}" \
            -H 'Accept: application/vnd.github+json' \
            "https://api.github.com/repos/${WEBSITE_REPO_FULL_NAME}/dispatches" \
            --data-binary @dispatch-payload.json)"

          if [ "${dispatch_status}" != '204' ]; then
            echo "Failed to dispatch production-ready event to ${WEBSITE_REPO_FULL_NAME}." >&2
            echo "Dispatch API status: ${dispatch_status}" >&2
            cat dispatch-response.txt >&2 || true
            exit 1
          fi

          echo "Dispatched conspectus-mobile-production-ready to ${WEBSITE_REPO_FULL_NAME}."
